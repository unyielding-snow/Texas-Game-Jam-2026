pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
local msg_shown = false

function _init()
	dtb_init(3)
	-- borrowed from https://gist.github.com/shaneriley/cae98eac6136e7293b28
	player = {}
	player.x = 25
	player.y = 25
	player.direction = "down"
	player.moving = false
	player.sprite = 0 player.speed = 1

	player.sprites = {
  down = {
    {64, 65, 80, 81},
    {66, 67, 82, 83},
    {68, 69, 84, 85},
    {64, 65, 80, 81}
  },
  up = {
    {70, 71, 86, 87},
    {72, 73, 88, 89},
    {74, 75, 90, 91},
    {70, 71, 86, 87}
  },
  right = {
    {96, 97, 112, 113},
    {98, 99, 114, 115},
    {100, 101, 116, 117},
    {96, 97, 112, 113}
  },
  left = {
    {102, 103, 118, 119},
    {104, 105, 120, 121},
    {106, 107, 122, 123},
    {102, 103, 118, 119}
  }
}
end

function _update()
	dtb_update()
-- player movement --
	player.moving = false
	local x = player.x
 local y = player.y

  if btn(0) then
    x -= player.speed
    move("left")
  end
  if btn(1) then
    x += player.speed
    move("right")
  end
  if btn(2) then
    y -= player.speed
    move("up")
  end
  if btn(3) then
    y += player.speed
    move("down")
  end
  
		local is_solid, is_interactive, interactive_tile_id = hit(x, y, 16, 16)
		if not is_solid then
    player.x = x
    player.y = y
  else
    if is_interactive and not msg_shown then
      local msg = get_interactive_message(interactive_tile_id)
      dtb_disp(msg)
      msg_shown = true
    end
  end
  
  if msg_shown then
			if btnp(4) then 
				dtb_q = {} 
				msg_shown = false 
			end
	end

  if not player.moving then
    player.sprite = 0
  end

end


function _draw()
	cls()
	map()
	
	local frame = player.sprites[player.direction][player.sprite + 1]
	spr(frame[1], player.x, player.y)
	spr(frame[2], player.x + 8, player.y)
	spr(frame[3], player.x, player.y + 8)
	spr(frame[4], player.x + 8, player.y + 8)

	dtb_draw()
end

-- borrowed from https://gamedev.docrobs.co.uk/first-steps-in-pico-8-easy-collisions-with-map-tiles
function hit(x, y, w, h)
	local is_solid = false
	local is_interactive = false
	local interactive_tile_id = nil
  for i = x, x + w - 1, 8 do
    for j = y, y + h - 1, 8 do
      local tile_x = flr(i / 8)
      local tile_y = flr(j / 8)
      local tile_id = mget(tile_x, tile_y)
      if fget(tile_id, 0) then  -- check flag 0
        is_solid = true
      end
      if fget(tile_id, 1) then
        is_interactive = true
        interactive_tile_id = tile_id
      end
    end
  end
  return is_solid, is_interactive, interactive_tile_id
end

function move(dir)
  player.moving = true
  player.direction = dir
  player.sprite = (player.sprite + 1) % #player.sprites[dir]
end

-- dialogue text box library by oli414. minimized.
function dtb_init(n) dtb_q={}dtb_f={}dtb_n=3 if n then dtb_n=n end _dtb_c() end function dtb_disp(t,c)local s,l,w,h,u s={}l=""w=""h=""u=function()if #w+#l>29 then add(s,l)l=""end l=l..w w=""end for i=1,#t do h=sub(t,i,i)w=w..h if h==" "then u()elseif #w>28 then w=w.."-"u()end end u()if l~=""then add(s,l)end add(dtb_q,s)if c==nil then c=0 end add(dtb_f,c)end function _dtb_c()dtb_d={}for i=1,dtb_n do add(dtb_d,"")end dtb_c=0 dtb_l=0 end function _dtb_l()dtb_c+=1 for i=1,#dtb_d-1 do dtb_d[i]=dtb_d[i+1]end dtb_d[#dtb_d]=""sfx(2)end function dtb_update()if #dtb_q>0 then if dtb_c==0 then dtb_c=1 end local z,x,q,c z=#dtb_d x=dtb_q[1]q=#dtb_d[z]c=q>=#x[dtb_c]if c and dtb_c>=#x then if btnp(4) then if dtb_f[1]~=0 then dtb_f[1]()end del(dtb_f,dtb_f[1])del(dtb_q,dtb_q[1])_dtb_c()sfx(2)return end elseif dtb_c>0 then dtb_l-=1 if not c then if dtb_l<=0 then local v,h v=q+1 h=sub(x[dtb_c],v,v)dtb_l=1 if h~=" " then sfx(0)end if h=="." then dtb_l=6 end dtb_d[z]=dtb_d[z]..h end if btnp(4) then dtb_d[z]=x[dtb_c]end else if btnp(4) then _dtb_l()end end end end end function dtb_draw()if #dtb_q>0 then local z,o z=#dtb_d o=0 if dtb_c<z then o=z-dtb_c end rectfill(2,125-z*8,125,125,0)if dtb_c>0 and #dtb_d[#dtb_d]==#dtb_q[1][dtb_c] then print("\x8e",118,120,1)end for i=1,z do print(dtb_d[i],4,i*8+119-(z+o)*8,7)end end end

function get_interactive_message(tile_id)
	if tile_id == 20 then
		return "it's a cozy bed... 🐱"
	elseif tile_id == 18 then
		return "the bookshelf contains a message hehe 😐."
	else
		return "smells funny in here...."
	end
end


__gfx__
0000000055555555dd444444444444dd44444444dddddddd77333335555555550000000000000000000000005555555555555555555555555555555555555555
0000000055555555dd418444444494dd77666677dddddddd77555555555555550000000000000000000000006666660550666666500600600600600600600600
0070070055555555dd444666644444dd77666677dddddddd55555555555555550000000000000000000000006666660550666666566066066066066066066066
0007700055555555dd444666645444dd77777777dddddddd55555555555555550000000000000000000000000000006556000000566066066066066066066066
0007700055555555dd444666645444dd22222222dddddddd55555555555555550000000000000000000000006666660550666666566066066066066066066066
0070070055555555dd444444444444dd22222222dddddddd55555555555555570000000000000000000000006666660550666666566066066066066066066066
0000000055555555dd444444444444dd22222222dddddddd55555555555555570000000000000000000000000000006556000000566066066066066066066066
0000000055555555dd500000000005dd22222222dddddddd55555555555555570000000000000000000000006666660550666666566066066066066066066066
00000000dddddddddd500000000005dd22222222dddddddd55555557555555550000000000000000666666666666660550666666555555555660660660660660
00000000dddddddddd5dddddddddd5dd22222222dddddddd55555557555555550000000000000000666666660000006556000000600655555660660660660660
00000000dddddddddddddddddddddddd22222222dddddddd55555555666666660000000000000000666666666666660550666666066055555660660660660660
00000000dddddddddddddddddddddddd22222222dddddddd55555555666666660000000000000000666666666666660550666666066055555660660660660660
00000000dddddddddddddddddddddddd22222222dddddddd55555555666666660000000000000000666666660000006556000000066055555660660660660660
00000000dddddddddddddddddddddddd22222222dddddddd55555555666666660000000000000000666666666666660550666666066055555660660660660660
00000000dddddddddddddddddddddddd22222222dddddddd55555555666566660000000000000000666666666666660550666666066055555006006006006006
00000000dddddddddddddddddddddddd44444444dddddddd55555555555555550000000000000000666666660000006556000000066055555555555555555555
00000000555544555554455555555555555555555555555500000000000000000000000000000000555555556666660550666666660660660660555555666655
00000000555544444444455555555555555555555555555500000000000000000000000000000000555555556666660550666666660660660660555555666655
00000000555541300038455555555999959995556666555500000000000000000000000000000000666666650000006556000000660660660660555555666655
0000000055554130883845555555599995999555ccc6555500000000000000000000000000000000666666656666660550666666660660660660555555066655
0000000055554444444445555555599995999555ccc6555500000000000000000000000000000000666666656666660550666666660660660660555555666655
0000000055554809020245555555599995999555ccc6555500000000000000000000000000000000666066650000006556000000660660660660555555666655
0000000055554811920245555555599995999555ccc6555500000000000000000000000000000000555555556666660550666666006006006006555555666655
00000000555544444444455555555999959995556666555500000000000000000000000000000000555555556666660550666666555555555555555555555555
00000000555543801900455555555555555555550000000000000000000000000000000000000000555555550000006556000000555555550000000000000000
0000000055554381aa90455555555999959995550000000000000000000000000000000000000000555555556666660550666666556666550000000000000000
00000000555544444444455555555999959995550000000000000000000000000000000000000000566606666666660550666666556666550000000000000000
00000000555540110322455555555999959995550000000000000000000000000000000000000000566666660000006556000000556666550000000000000000
00000000555540113088455555555999959995550000000000000000000000000000000000000000566666665555555555555555556660550000000000000000
00000000555544444444455555555999959995550000000000000000000000000000000000000000566666665555555555555555556666550000000000000000
00000000dddd400000004ddd55555555555555550000000000000000000000000000000000000000555555555555555555555555556666550000000000000000
00000000dddddddddddddddd55555555555555550000000000000000000000000000000000000000555555555555555555555555556666550000000000000000
00000000000000000222022222220222022202222222022200000000000000000222022222220222022202222222022200000000000000000000000000000000
02220222222202220222222222222222022222222222222202220222222202220222222222222222022222222222222200000000000000000000000000000000
02222222222222220222222222222222022222222222222202222222222222220222222222222222022222222222222200000000000000000000000000000000
02222222222222220022222ff22222200022222ff222222002222222222222220022222222222220002222222222222000000000000000000000000000000000
0022222ff22222200222220fff0222200222220fff02222000222222222222200222222222222220022222222222222000000000000000000000000000000000
0222220fff02222002222f0fff0f222202222f0fff0f222202222222222222200222222222222222022222222222222200000000000000000000000000000000
02222f0fff0f222200222fffffff222000222fffffff222002222222222222220022222222222220002222222222222000000000000000000000000000000000
00222fffffff22200002277777772200000227777777220000222222222222200002222222222200000222222222220000000000000000000000000000000000
00022777777722000000f7777777f0000000f7777777f00000022222222222000000f7777777f0000000f7777777f00000000000000000000000000000000000
0000f7777777f000000001111111000000000111111100000000f7777777f0000000011111110000000001111111000000000000000000000000000000000000
00000111111100000000011111110000000001111111000000000111111100000000011111110000000001111111000000000000000000000000000000000000
00000111111100000000011101110000000001110111000000000111111100000000011101110000000001110111000000000000000000000000000000000000
00000111011100000000000001110000000001110000000000000111011100000000000001110000000001110000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000022202222220000002220222222000000000000000000000022222202220000002222220222000000000000000000000000000000000000
00222022222200000022222222222000002222222222200000222222022200000222222222220000022222222222000000000000000000000000000000000000
00222222222220000022222222222200002222222222220002222222222200002222222222220000222222222222000000000000000000000000000000000000
00222222222222000002222222222200000222222222220022222222222200002222222222200000222222222220000000000000000000000000000000000000
0002222222222200002222222222f200002222222222f20022222222222000002f222222222200002f2222222222000000000000000000000000000000000000
002222222222f200022222222220f000022222222220f0002f222222222200000f022222222220000f0222222222200000000000000000000000000000000000
022222222220f0000222222222f0f0000222222222f0f0000f022222222220000f0f2222222220000f0f22222222200000000000000000000000000000000000
0222222222f0f0000022222222fff0000022222222fff0000f0f2222222220000fff2222222200000fff22222222000000000000000000000000000000000000
0022222222fff000000222222277000000022222227700000fff2222222200000077222222200000007722222220000000000000000000000000000000000000
00022222227700000000007ff77700000000007ff7770000007722222220000000777ff70000000000777ff70000000000000000000000000000000000000000
0000007ff77700000000001111110000000000111111000000777ff7000000000011111100000000001111110000000000000000000000000000000000000000
00000011111100000000001111110000000000111111000000111111000000000011111100000000001111110000000000000000000000000000000000000000
00000011111100000000001110110000000000111011000000111111000000000011011100000000001101110000000000000000000000000000000000000000
00000011101100000000001110000000000000000011000000110111000000000000011100000000001100000000000000000000000000000000000000000000
__gff__
0000000103010000000000000000000000000300030000000000000000000000000103010101000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101070501010101000000000000000000000000000001010101110101000000010101010101010121220101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101160612120101000000000000000000000000000001011111110101000000010101010101010131320101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0325041122221101000000000000000000000000000001011111110101000000232404051111020311110101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2324141111111101000000000000000000000000000001011111110101000000333414151111121311110101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101111111111117000000000000000a0a0a0a00000003251111210101000000010111111111111111110101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101151111111101000000000000000a0a0a0a00000023241111310101010101010111111111111111110101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101110101000000000000000000000000000001011111110101010101010111111111111111110101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101011111110101000000000000000000000000000001013211111111111111010111111111111111110101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101011111110101000000000000000000000000000001013311111111111111010111111111111111110101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101011111110101000000000000000000000000000001010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101011111210101000000000000000000000000000001010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101011111310101010101000000000000000000000000000000000000000000010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101011111110101010101000000000000000000000000000000000000000000010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101013211111111111111000000000000000000000000000000000000000000010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101013311111111111101000000000000000000000000000000000000000000010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101000000000000000000000000000000000000000000010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101000000000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101013211010101010101010100000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101013211010101010101010100000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0111111111111111010101010100000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0111111111111111111111010100000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011111111111111111111101013d0d0e01010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011111111111111111111101011a1a1a01010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a111111111111111111111a1a1a1a1a01010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a111111111111111111111a1a1a1a1a01010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a111111111111111111111e1f2d2e0a01010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a01010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
